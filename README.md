# Wikipedia Log Analysis System

## 目的
Wikipediaのアクセスログの情報を使い、サイトのユーザーの活動に関する質問に答えるシステムを作成

このシステムはコマンドラインから実行されるプログラムで、データベースに接続し、SQLクエリを使ってアクセスログを分析し、いくつかの質問に対する答えを出力する。

## システム概要

1.最もビュー数の多い記事を、指定した記事数分だけビュー数が多い順にソートし、ドメインコードとページタイトル、ビュー数を提示する

（例）コマンドライン上で2記事と指定した場合、下記を表示する

”en”, “Main_Page”, 120

”en”, ”Wikipedia:Umnyango_wamgwamanda”, 112

2.指定したドメインコードに対して、人気順にソートし、ドメインコード名と合計ビュー数を提示する

（例）コマンドライン上で「en de」と指定した場合、下記を表示する

”en”, 10700

”de”, 5300

## 解析に使用するデータ

wikipediaで公開されている、アクセスログを集計したファイルをダウンロードして使用します。
データは2021年12月1日のものを使用しました。下記URLからダウンロードできます。
https://dumps.wikimedia.org/other/pageviews/2021/2021-12/

### データの概要

データはページごとの閲覧数を1時間ごとに集計したものがgzipで圧縮されています。
データはスペースで区切られ、以下の4つカラムからなる行で構成されています。

1. ドメインコード
    リクエストのドメイン名を省略した形式で表記

2. ページタイトル
    リクエストされたURLの/wiki/の後の非正規化された部分のタイトルを保持

3. 閲覧回数
    集計時間内にこのページが閲覧された回数

4. 総レスポンスサイズ
    集計時間内にこのページへのリクエストによって引き起こされたレスポンスサイズの合計。Wikiのデータではすべて0となっているので今回は参照しない。

サンプル(先頭5行)

```text
aa Main_Page 4 0
aa Wikipedia 1 0
aa Wikipedia:Statistics 1 0
aa.b Main_Page 1 0
aa.d Main_Page 4 0
```

今回使用したファイルでは、このようなデータが約510万行入っています。
公開されているデータについての全体の解説、テーブル定義の詳細は下記URLをご参照ください。
https://dumps.wikimedia.org/other/pageviews/readme.html
https://wikitech.wikimedia.org/wiki/Analytics/Data_Lake/Traffic/Pageviews

##  Wikipedia Log Analysis System 使用方法

あらかじめ解析に使用するファイルをダウンロード、展開し、app/log_fileディレクトリにpage_viewsという名前で保存

```bash
# Dockerコンテナの生成、起動
$ docker compose up -d --build

# 解析プログラムの実行
$ docker compose exec app php wiki_log_analyze.php

# DBを削除してDockerコンテナを停止、削除する
$ docker compose down -v
```

実行例
```bash
ログファイルをデータベースにインポート中です。
インポートが完了しました

解析するタスクナンバーを入力してください。終了するには0を入力してください
タスク1: 記事数を指定して、閲覧数の多い順に表示します
タスク2: ドメインコードを入力し、閲覧数の多い順に合計閲覧数を表示します
1
表示する記事数を入力してください
5
en.m Main_Page 122058
en Main_Page 69181
en Special:Search 26630
de Wikipedia:Hauptseite 20739
en.m Special:Search 19119

解析するタスクナンバーを入力してください。終了するには0を入力してください
タスク1: 記事数を指定して、閲覧数の多い順に表示します
タスク2: ドメインコードを入力し、閲覧数の多い順に合計閲覧数を表示します
2
表示するドメインコードをスペース区切りで入力してください(例: de ja fr)
de ja fr
ja 367924
de 284178
fr 242520

解析するタスクナンバーを入力してください。終了するには0を入力してください
タスク1: 記事数を指定して、閲覧数の多い順に表示します
タスク2: ドメインコードを入力し、閲覧数の多い順に合計閲覧数を表示します
0
プログラムを終了します
```
